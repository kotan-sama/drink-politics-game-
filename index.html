<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Slot Game</title>
<style>
body{
    font-family:sans-serif;
    text-align:center;
    background:#0b5b2e;
    color:white;
}
#table{
    position:relative;
    width:90vw;
    height:90vw;
    max-width:800px;
    margin:0 auto;
    border-radius:50%;
    background:#0f7a3e;
}
button{
    margin:5px;
    padding:10px 20px;
    font-size:16px;
}
.player{
    position:absolute;
    width:150px;
    transform:translate(-50%,-50%);
    text-align:center;
}
.name{
    background:#ffffff33;
    border:1px solid white;
    color:white;
}
.slot,.center-slot{
    width:90px;
    height:130px;
    margin:6px auto;
    border-radius:10px;
    background:white;
    display:flex;
    align-items:center;
    justify-content:center;
}
.slot img,.center-slot img{
    width:80px;
    height:auto;
}
.score{
    font-size:18px;
}
.active{
    outline:4px solid yellow;
}
.gain2{
    box-shadow:0 0 15px 6px gold inset;
}
.gain1{
    box-shadow:0 0 10px 4px lightblue inset;
}
#deckArea{ margin-top:10px; }
#drawnCardArea{
    margin-top:10px;
    width:100px;
    height:145px;
    border:2px solid yellow;
    border-radius:10px;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    margin:10px auto;
}
#rules{
    background:#fff;
    color:#000;
    padding:20px;
    width:400px;
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    border-radius:12px;
    display:none;
}
.overlay{
    position:fixed;
    inset:0;
    background:#0008;
    display:none;
}
</style>
</head>

<body>

<h1>Card Slot Game</h1>

<label>プレイヤー人数：</label>
<select id="numPlayers">
<option>2</option><option>3</option><option>4</option><option>5</option>
<option>6</option><option>7</option><option>8</option>
</select>
<button id="start">ゲーム開始</button>
<button id="showRule">ルール</button>

<div id="deckArea">山札残り：<span id="deckCount">0</span>枚</div>
<div id="drawnCardArea"></div>

<div id="table"></div>
<button id="getCard" disabled>カードを引く</button>

<div class="overlay" id="ov"></div>
<div id="rules">
<h3>ルール</h3>
<p>
プレイヤー人数＋中央の合計分のスロットがあります。<br>
手番のプレイヤーは山札から1枚引き、好きなスロットに置きます。
</p>
<ul>
<li>中央と自分のカードが一致 → +2点</li>
<li>中央と1違い（A⇔K含む） → +1点</li>
<li>自分のカードがジョーカー → +3点</li>
<li>中央がジョーカー → 全員 +3点</li>
</ul>
<button onclick="hideRule()">閉じる</button>
</div>

<script>
// --- カード情報 ---
const suits=["S","H","D","C"];
const ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
let deck=[],players=[],centerCard=null,centerDom=null,turn=0,drawnCard=null;

// --- カード画像 ---
function cardImg(card){ return `<img src="cards/${card}.png" style="width:90%;height:auto;">`; }

// --- 山札生成 ---
function makeDeck(){
    deck = [];
    for(let s of suits){
        for(let r of ranks){
            deck.push(r+s);
        }
    }
    deck.push("JokerR","JokerB");
    deck.sort(()=>Math.random()-0.5);
    updateDeckCount();
}

// --- 山札カウント更新 ---
function updateDeckCount(){ document.getElementById("deckCount").innerText = deck.length; }

// --- ランク抽出 ---
function getRank(card){
    if(card==="JokerR" || card==="JokerB") return null;
    return card.slice(0, card.length-1);
}

// --- テーブル描画 ---
function renderTable(n){
    const t=document.getElementById("table");
    t.innerHTML="";
    players=[];
    let cx=400,cy=400,r=300;

    for(let i=0;i<n;i++){
        let ang=2*Math.PI*i/n-Math.PI/2;
        let x=cx+r*Math.cos(ang), y=cy+r*Math.sin(ang);
        let div=document.createElement("div");
        div.className="player";
        div.style.left=x+"px"; div.style.top=y+"px";

        div.innerHTML=`
            <input class="name" value="Player ${i+1}">
            <div class="slot"></div>
            <div class="score">0</div>
        `;
        t.appendChild(div);
        players.push({card:null,score:0,dom:div});
    }

    let c=document.createElement("div");
    c.className="center-slot";
    c.style.position="absolute";
    c.style.left=cx+"px";
    c.style.top=cy+"px";
    c.style.transform="translate(-50%,-50%)";
    t.appendChild(c);
    centerDom=c;
}

// --- ゲーム開始 ---
function startGame(){
    makeDeck();
    renderTable(parseInt(document.getElementById("numPlayers").value));
    turn=0; highlightTurn();

    // 初期配布
    players.forEach(p=>{
        p.card=deck.pop();
        p.dom.querySelector(".slot").innerHTML=cardImg(p.card);
    });
    centerCard=deck.pop();
    centerDom.innerHTML=cardImg(centerCard);

    document.getElementById("getCard").disabled=false;
}

// --- ターンハイライト ---
function highlightTurn(){
    document.querySelectorAll(".player").forEach((p,i)=>{
        p.classList.toggle("active",i===turn);
    });
}

// --- スロット操作 ---
function enableSlots(){
    players.forEach((p,i)=>{
        p.dom.querySelector(".slot").onclick=()=>{
            if(!drawnCard) return;
            p.card=drawnCard;
            p.dom.querySelector(".slot").innerHTML=cardImg(p.card);
            finishPlacement();
        }
    });
}

function disableSlots(){ players.forEach(p=>p.dom.querySelector(".slot").onclick=null); }

// --- スコア判定 ---
function scoreCheck(i){
    let pc=players[i].card;
    let cc=centerCard;
    if(pc==="JokerR"||pc==="JokerB"){ addScore(i,3); pulse(i,3); return; }
    if(cc==="JokerR"||cc==="JokerB"){ players.forEach((_,j)=>{ addScore(j,3); pulse(j,3); }); return; }
    let pv=ranks.indexOf(getRank(pc)), cv=ranks.indexOf(getRank(cc));
    if(pv===-1||cv===-1) return;
    if(pv===cv){ addScore(i,2); pulse(i,2); return; }
    if((pv+1)%13===cv || (cv+1)%13===pv){ addScore(i,1); pulse(i,1); return; }
}

// --- 全員判定 ---
function scoreAllPlayers(){ players.forEach((_,i)=>scoreCheck(i)); }

// --- 得点加算・演出 ---
function addScore(i,pts){
    players[i].score+=pts;
    players[i].dom.querySelector(".score").innerText=players[i].score;
}
function pulse(i,pts){
    let el=players[i].dom.querySelector(".slot");
    el.classList.add(pts===2?"gain2":"gain1");
    setTimeout(()=>el.classList.remove("gain2","gain1"),900);
}

// --- ターン終了処理 ---
function finishPlacement(){
    drawnCard=null;
    disableSlots();
    scoreAllPlayers();
    turn=(turn+1)%players.length;
    highlightTurn();
    document.getElementById("drawnCardArea").innerHTML="";
}

// --- ボタン操作 ---
document.getElementById("start").onclick=startGame;

document.getElementById("getCard").onclick=()=>{
    if(deck.length===0){ alert("ゲーム終了！"); return; }
    drawnCard=deck.pop();
    updateDeckCount();
    document.getElementById("drawnCardArea").innerHTML=cardImg(drawnCard);
    enableSlots();
};

document.getElementById("showRule").onclick=()=>{ ov.style.display="block"; rules.style.display="block"; };
function hideRule(){ ov.style.display="none"; rules.style.display="none"; }
</script>

</body>
</html>
